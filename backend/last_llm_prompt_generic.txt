
ROLE: Senior Database Performance Architect.
TASK: Analyze this database health snapshot and the calculated score.

SCORING POLICY:
Calculated Score: 44/100
Deductions:
-15 pts: Query 1067360644143004675 impacts >25% of DB time
-30 pts: 5 Slow Queries (>100ms) detected
-2 pts: 1 unused indexes found
-5 pts: Configuration issue: autovacuum_vacuum_scale_factor
-5 pts: Configuration issue: work_mem

INPUT DATA:
1. WORKLOAD SUMMARY:
Query 1067360644143004675 (4 calls, 56.1% DB Load): INSERT INTO golden.orders (user_id, amount, created_at)
SELECT 
    floor(random() * $1) + $2,
    (random() * $3)::decimal(10,2),
    now() - (random() * interval $4)
FROM generate_series($5, $6)
ON ...
Query 3849042847910914801 (1 calls, 8.0% DB Load): INSERT INTO golden.events (event_type, user_id, metadata, created_at)
SELECT 
    (ARRAY[$1, $2, $3, $4, $5])[floor(random()*$6)+$7],
    floor(random()*$8)+$9,
    $10::jsonb,
    now() - (random() *...
Query 4722114336809465332 (40 calls, 7.0% DB Load): SELECT * FROM golden.orders WHERE user_id = $1...
Query 2198776396486139047 (250 calls, 6.0% DB Load): SELECT 
                        blks_hit,
                        blks_read,
                        CASE WHEN (blks_hit + blks_read) > $1 
                        THEN (blks_hit::float / (blks_hit + ...
Query -7628780372509789239 (40 calls, 3.0% DB Load): SELECT event_type, count(*) FROM golden.events GROUP BY event_type ORDER BY count(*) DESC...
Query -5407454471899941846 (100000 calls, 2.4% DB Load): INSERT INTO demo_user_activity (user_id, session_id, activity_type, path, metadata, ip_address)
            VALUES ($1, $2, $3, $4, $5, $6)...
Query 3045279610877397324 (29982 calls, 1.8% DB Load): INSERT INTO demo_order_items (order_id, product_id, quantity, unit_price)
            VALUES ($1, $2, $3, $4)...
Query -819779407729419923 (1 calls, 1.4% DB Load): INSERT INTO golden.product_reviews (product_id, rating, comment, created_at)
SELECT 
    floor(random()*$1)+$2,
    floor(random()*$3)+$4,
    $5 || i,
    now() - (random() * interval $6)
FROM genera...
Query 455203738940632858 (40 calls, 1.2% DB Load): SELECT p.name, r.rating FROM golden.products p JOIN golden.product_reviews r ON p.id = r.product_id WHERE r.rating = $1...
Query -3046278729045895260 (1 calls, 1.0% DB Load): INSERT INTO demo_user_activity (user_id, activity_type, path)
        SELECT (id % $1) + $2, $3, $4
        FROM generate_series($5, $6) as id...
Query -2198701224448015375 (10000 calls, 0.9% DB Load): INSERT INTO demo_orders (user_id, coupon_id, order_status, total_amount, shipping_address)
            VALUES ($1, $2, $3, $4, $5) RETURNING id...
Query 4342568929360145201 (40 calls, 0.9% DB Load): SELECT * FROM golden.users WHERE extract($1 from created_at) = $2...
Query 5127892585943994168 (468 calls, 0.6% DB Load): SELECT
                        
            CAST(queryid AS TEXT) AS queryid,
            query,
            (total_exec_time + COALESCE(total_plan_time, $1))::BIGINT AS total_time,
            calls:...
Query -3480351236619452562 (250 calls, 0.5% DB Load): SELECT 
                        (SELECT count(*) FROM pg_stat_activity WHERE state = $1) AS active,
                        (SELECT setting::int FROM pg_settings WHERE name = $2) AS max_conn...
Query -7692504400675491319 (29982 calls, 0.4% DB Load): SELECT price FROM demo_products WHERE id = $1...
Query -5021158068330170812 (4 calls, 0.4% DB Load): INSERT INTO golden.users (username, created_at)
SELECT 
    $1 || i,
    now() - (random() * interval $2)
FROM generate_series($3, $4) s(i)
ON CONFLICT DO NOTHING...
Query -6920067218416300113 (1 calls, 0.3% DB Load): CREATE DATABASE "optischema_sandbox"...
Query -3795172097531242972 (468 calls, 0.3% DB Load): SELECT COUNT(*) FROM pg_stat_statements WHERE $1=$2...
Query 9027282982159850306 (5000 calls, 0.2% DB Load): INSERT INTO demo_reviews (product_id, user_id, rating, comment, is_verified, helpful_votes)
        VALUES ($1, $2, $3, $4, $5, $6)...
Query 5892058600941481618 (94 calls, 0.2% DB Load): SELECT EXISTS(SELECT $1 FROM pg_available_extensions WHERE name = $2)...
Query 268600926442515968 (38 calls, 0.2% DB Load): SELECT 
                            n.nspname AS schemaname,
                            c.relname AS tablename,
                            COALESCE(c.reltuples::bigint, $1) AS approximate_rows,
    ...
Query 2404841235201174749 (250 calls, 0.2% DB Load): SELECT COALESCE(SUM(calls), $1)::float 
                                FROM pg_stat_statements...
Query 6424265396634294763 (38 calls, 0.1% DB Load): SELECT pg_size_pretty(pg_database_size(current_database()))...
Query 7181379362645473403 (1 calls, 0.1% DB Load): DELETE FROM demo_user_activity WHERE activity_type = $1...
Query 7791678355880329977 (6 calls, 0.1% DB Load): SELECT queryid, query, total_exec_time::float, calls, mean_exec_time::float 
                    FROM pg_stat_statements 
                    WHERE query NOT ILIKE $1
                      AND query N...
Query 8833304061238510377 (2000 calls, 0.1% DB Load): INSERT INTO demo_users (username, email, password_hash, first_name, last_name, profile_data)
        VALUES ($1, $2, $3, $4, $5, $6)...
Query -4409768048470291899 (2000 calls, 0.0% DB Load): INSERT INTO demo_inventory (product_id, warehouse_id, quantity, reserved_quantity)
        VALUES ($1, $2, $3, $4)...
Query -148009270499742334 (250 calls, 0.0% DB Load): SELECT 
                            buffers_checkpoint,
                            buffers_clean,
                            buffers_backend,
                            checkpoints_timed,
         ...
Query -9059010411993093371 (1 calls, 0.0% DB Load): CREATE TABLE demo_users (
            id SERIAL PRIMARY KEY,
            uuid UUID DEFAULT uuid_generate_v4(),
            username VARCHAR(50) UNIQUE NOT NULL,
            email VARCHAR(100) NOT NULL...
Query -326687354113255463 (1 calls, 0.0% DB Load): CREATE TABLE demo_orders (
            id SERIAL PRIMARY KEY,
            user_id INTEGER NOT NULL REFERENCES demo_users(id),
            coupon_id INTEGER REFERENCES demo_coupons(id),
            ord...
Query -7530366520948501182 (197 calls, 0.0% DB Load): SELECT column_name, data_type, is_nullable
                    FROM information_schema.columns 
                    WHERE table_schema = $1 AND table_name = $2
                    ORDER BY ordinal_pos...
Query -6439256685934866771 (2 calls, 0.0% DB Load): CREATE TABLE IF NOT EXISTS golden.products (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    category TEXT,
    price DECIMAL(10,2)
)...
Query -3983319599630595861 (4 calls, 0.0% DB Load): CREATE TABLE IF NOT EXISTS golden.user_roles (
    id SERIAL PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL,
    description TEXT
)...
Query 4033005512882497756 (817 calls, 0.0% DB Load): SELECT EXISTS(SELECT $1 FROM pg_extension WHERE extname = $2)...
Query 3264360654561004003 (1 calls, 0.0% DB Load): SELECT 
                s.schemaname as schema, 
                s.relname as table, 
                s.indexrelname as index,
                s.idx_scan as scans,
                pg_size_pretty(pg_re...
Query -3470958896123247098 (1 calls, 0.0% DB Load): CREATE TABLE demo_metadata (
            id SERIAL PRIMARY KEY,
            key VARCHAR(100) UNIQUE NOT NULL,
            value JSONB,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      ...
Query 5725020115533372324 (1 calls, 0.0% DB Load): SELECT COUNT(*) FROM demo_user_activity WHERE activity_type = $1...
Query 7748111147449227153 (4 calls, 0.0% DB Load): CREATE TABLE IF NOT EXISTS golden.orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    amount DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT NOW()
)...
Query 229945978952501599 (197 calls, 0.0% DB Load): SELECT indexname, indexdef
                    FROM pg_indexes
                    WHERE schemaname = $1 AND tablename = $2...
Query -1704259279724963883 (1 calls, 0.0% DB Load): CREATE TABLE demo_products (
            id SERIAL PRIMARY KEY,
            sku VARCHAR(50) UNIQUE NOT NULL,
            name VARCHAR(200) NOT NULL,
            description TEXT,
            price DEC...
Query 319117687522602705 (3 calls, 0.0% DB Load): CREATE TABLE IF NOT EXISTS golden.benchmark_results (
    id SERIAL PRIMARY KEY,
    scenario_id TEXT,
    query_text TEXT,
    prompt TEXT,
    raw_response TEXT,
    actual_category TEXT,
    expect...
Query 1592588011879541419 (1 calls, 0.0% DB Load): SELECT count(*) FROM demo_products p1, demo_products p2 WHERE p1.category = p2.category AND p1.id < p2.id LIMIT $1...
Query -7343623629186431574 (2 calls, 0.0% DB Load): CREATE TABLE IF NOT EXISTS golden.events (
    id SERIAL PRIMARY KEY,
    event_type TEXT,
    user_id INTEGER,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW()
)...
Query -8072334494413606497 (15 calls, 0.0% DB Load): SELECT name as setting, setting as current_value, unit 
                    FROM pg_settings 
                    WHERE name IN ($1, $2, $3, $4, $5, $6)...
Query 1246389880547687030 (1 calls, 0.0% DB Load): CREATE TABLE demo_coupons (
            id SERIAL PRIMARY KEY,
            code VARCHAR(20) UNIQUE NOT NULL,
            discount_percent INTEGER CHECK (discount_percent > 0 AND discount_percent <= 10...
Query -7400275180584382714 (2 calls, 0.0% DB Load): INSERT INTO golden.products (name, category, price)
SELECT 
    $1 || i,
    (ARRAY[$2, $3, $4, $5])[floor(random()*$6)+$7],
    (random()*$8)::decimal(10,2)
FROM generate_series($9, $10) s(i)
ON CONF...
Query 4406237015954124278 (83 calls, 0.0% DB Load): INSERT INTO golden.benchmark_results 
                    (scenario_id, query_text, prompt, raw_response, actual_category, actual_sql, alignment_score)
                    VALUES ($1, $2, $3, $4, $5, ...
Query 7940119945537634477 (1 calls, 0.0% DB Load): CREATE TABLE demo_user_activity (
            id BIGSERIAL PRIMARY KEY,
            user_id INTEGER REFERENCES demo_users(id),
            session_id VARCHAR(100),
            activity_type VARCHAR(50...
Query 8210043489720114568 (29 calls, 0.0% DB Load): SELECT hypopg_create_index($1)...
Query 2564710703375654551 (1000 calls, 0.0% DB Load): INSERT INTO demo_products (sku, name, description, price, category, tags, attributes)
        VALUES ($1, $2, $3, $4, $5, $6, $7)...

2. BLOAT: []
3. CONFIG: [<Record setting='autovacuum_vacuum_scale_factor' current_value='0.2' unit=None>, <Record setting='effective_cache_size' current_value='524288' unit='8kB'>, <Record setting='maintenance_work_mem' current_value='65536' unit='kB'>, <Record setting='max_connections' current_value='100' unit=None>, <Record setting='shared_buffers' current_value='16384' unit='8kB'>, <Record setting='work_mem' current_value='4096' unit='kB'>]
4. UNUSED INDEXES: [<Record schema='public' table='demo_inventory' index='idx_inventory_qty' scans=0 tuples_read=0 tuples_fetched=0 size='104 kB' size_bytes=106496>]

YOUR GOAL: 
Explain the score and prioritize the issues. 
If a query has high 'DB Load %' (even if low latency), it is a CRITICAL optimization target. 
Demand specific fixes (like "Add index for join") in your explanation.

OUTPUT JSON FORMAT:
{
  "health_score": 44,
  "issues": [
    {
      "type": "QUERY" | "CONFIG" | "SCHEMA",
      "severity": "CRITICAL" | "WARNING" | "INFO",
      "title": "Title",
      "description": "Explain WHY this matters based on stats.",
      "action_payload": "Context"
    }
  ]
}

STRICT RULES FOR 'type' AND 'action_payload':
1. type="QUERY": Use ONLY for specific slow/heavy queries from the WORKLOAD SUMMARY.
   - action_payload MUST be the 'queryid' (e.g., "123456789"). DO NOT put SQL here.
2. type="SCHEMA": Use for Bloat, Vacuum, or Missing Index issues.
   - action_payload MUST be the generic SQL command to fix it (e.g., "VACUUM FULL public.users;", "CREATE INDEX ON...").
3. type="CONFIG": Use for Postgres settings (work_mem, etc).
   - action_payload MUST be the SQL command to change it (e.g., "ALTER SYSTEM SET work_mem = '64MB';").
}
