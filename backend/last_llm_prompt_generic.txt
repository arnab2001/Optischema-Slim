
ROLE: Senior Database Performance Architect.
TASK: Analyze this database health snapshot and the calculated score.

SCORING POLICY:
Calculated Score: 45/100
Deductions:
-15 pts: Query 7148384631871485258 impacts >20% of DB time
-5 pts: Query -2397772004562253861 impacts >20% of DB time
-30 pts: 10 Slow Queries (>100ms) detected
-5 pts: Configuration issue: work_mem

INPUT DATA:
1. WORKLOAD SUMMARY:
Query 7148384631871485258 (1260876 calls, 53.0% DB Load): SELECT "UserSessionHistoryEntity"."id" AS "UserSessionHistoryEntity_id", "UserSessionHistoryEntity"."user_id" AS "UserSessionHistoryEntity_user_id", "UserSessionHistoryEntity"."session_id" AS "UserSes...
Query -2397772004562253861 (409624 calls, 29.2% DB Load): SELECT "UserSessionHistoryEntity"."id" AS "UserSessionHistoryEntity_id", "UserSessionHistoryEntity"."user_id" AS "UserSessionHistoryEntity_user_id", "UserSessionHistoryEntity"."session_id" AS "UserSes...
Query 4305677000996077385 (467420 calls, 3.2% DB Load): SELECT "UserActiveSessionsEntity"."id" AS "UserActiveSessionsEntity_id", "UserActiveSessionsEntity"."user_id" AS "UserActiveSessionsEntity_user_id", "UserActiveSessionsEntity"."clientId" AS "UserActiv...
Query -601833048549239672 (4852416 calls, 2.0% DB Load): SELECT "UserRolesEntity"."id" AS "UserRolesEntity_id", "UserRolesEntity"."user_id" AS "UserRolesEntity_user_id", "UserRolesEntity"."tenant_id" AS "UserRolesEntity_tenant_id", "UserRolesEntity"."role_i...
Query -5215524276360263312 (81349 calls, 1.0% DB Load): SELECT count(*) FROM pg_show_all_settings() WHERE name = $1 AND setting SIMILAR TO $2...
Query -717554648271801837 (144262 calls, 0.9% DB Load): SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastName", "User"."username" AS "User_username", "User"."email" AS "Us...
Query -13652532916514886 (2263973 calls, 0.8% DB Load): SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastName", "User"."username" AS "User_username", "User"."email" AS "Us...
Query 1147920061924052358 (1356949 calls, 0.7% DB Load): SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastName", "User"."username" AS "User_username", "User"."email" AS "Us...
Query -7703039548626567399 (10 calls, 0.5% DB Load): COPY "usm-auth".session_data (id, user_id, "clientId", access_token, refresh_token, created_at, updated_at, session_id) TO stdout...
Query 804280987404448131 (72906 calls, 0.4% DB Load): SELECT "SessionDataEntity"."id" AS "SessionDataEntity_id", "SessionDataEntity"."user_id" AS "SessionDataEntity_user_id", "SessionDataEntity"."clientId" AS "SessionDataEntity_clientId", "SessionDataEnt...
Query -3884425969539893064 (813571 calls, 0.4% DB Load): select s.*, extract($1 from s.lastattempt) as lastattempt_ts from rds_get_stat_connections_counters() as s where s.lastattempt > (now() - interval $2 second) limit $3...
Query 6950166492309811154 (411583 calls, 0.2% DB Load): SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastName", "User"."username" AS "User_username", "User"."email" AS "Us...
Query -3746286325921742362 (233026 calls, 0.2% DB Load): SELECT "UserActiveSessionsEntity"."id" AS "UserActiveSessionsEntity_id", "UserActiveSessionsEntity"."user_id" AS "UserActiveSessionsEntity_user_id", "UserActiveSessionsEntity"."access_token" AS "UserA...
Query -4545949112955291562 (6570 calls, 0.2% DB Load): SELECT DISTINCT "distinctAlias"."User_id" AS "ids_User_id" FROM (SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastN...
Query -3146807096129156104 (3257013 calls, 0.2% DB Load): SELECT count(*) FROM information_schema.tables WHERE table_catalog = $1 and table_name = $2...
Query -4544315956129062237 (2264307 calls, 0.2% DB Load): SELECT DISTINCT "distinctAlias"."User_id" AS "ids_User_id" FROM (SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastN...
Query 3721457210601179865 (6570 calls, 0.2% DB Load): SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastName", "User"."username" AS "User_username", "User"."email" AS "Us...
Query 7252068675568837821 (504 calls, 0.2% DB Load): SELECT "UserTenantMapEntity"."id" AS "UserTenantMapEntity_id", "UserTenantMapEntity"."user_id" AS "UserTenantMapEntity_user_id", "UserTenantMapEntity"."tenant_id" AS "UserTenantMapEntity_tenant_id", "...
Query 3239281503123634245 (217843 calls, 0.1% DB Load): SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastName", "User"."username" AS "User_username", "User"."email" AS "Us...
Query -358896828156024895 (605 calls, 0.1% DB Load): SELECT
                        
            CAST(queryid AS TEXT) AS queryid,
            query,
            (total_exec_time + COALESCE(total_plan_time, $1))::BIGINT AS total_time,
            calls:...
Query 5415430352759649894 (144274 calls, 0.1% DB Load): SELECT DISTINCT "distinctAlias"."User_id" AS "ids_User_id" FROM (SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastN...
Query 6865378226349601843 (22177889 calls, 0.1% DB Load): SELECT $1...
Query 5178866452841943580 (605 calls, 0.1% DB Load): SELECT COUNT(*) FROM pg_stat_statements WHERE $1=$2 AND query NOT ILIKE $3 AND query NOT ILIKE $4 AND query NOT ILIKE $5 AND query NOT ILIKE $6 AND query NOT ILIKE $7 AND query NOT ILIKE $8 AND query ...
Query 4370192409647142863 (1357144 calls, 0.1% DB Load): SELECT DISTINCT "distinctAlias"."User_id" AS "ids_User_id" FROM (SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastN...
Query -3287996059913192073 (93 calls, 0.1% DB Load): SELECT * FROM "usm-auth".users
ORDER BY id ASC...
Query 1264246089659787811 (3827072 calls, 0.1% DB Load): SELECT "RolePermissionDefaultMapEntity"."id" AS "RolePermissionDefaultMapEntity_id", "RolePermissionDefaultMapEntity"."role_id" AS "RolePermissionDefaultMapEntity_role_id", "RolePermissionDefaultMapEn...
Query 330873039911247181 (7 calls, 0.1% DB Load): COPY "usm-auth"."migrated-users" (_id, address, city, company, confirmation_sent_at, confirmation_token, confirmed_at, country, created_at, current_sign_in_at, current_sign_in_ip, designation, email, ...
Query 7577153489144742230 (92349 calls, 0.1% DB Load): SELECT "MigratedUser"."_id" AS "MigratedUser__id", "MigratedUser"."address" AS "MigratedUser_address", "MigratedUser"."city" AS "MigratedUser_city", "MigratedUser"."company" AS "MigratedUser_company",...
Query 7184591659992242553 (1875 calls, 0.1% DB Load): SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastName", "User"."username" AS "User_username", "User"."email" AS "Us...
Query 2660562202098311341 (10 calls, 0.1% DB Load): SELECT * FROM "usm-auth".user_active_sessions
ORDER BY id ASC...
Query 6504696569616983000 (9 calls, 0.1% DB Load): COPY "usm-auth".user_session_history (id, user_id, start_time, end_time, created_at, updated_at, session_id) TO stdout...
Query 5365425778184941572 (1875 calls, 0.1% DB Load): SELECT DISTINCT "distinctAlias"."User_id" AS "ids_User_id" FROM (SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastN...
Query -7292323289345312841 (13877 calls, 0.1% DB Load): DELETE FROM "usm-auth"."session_data" WHERE "user_id" = $1...
Query 1673139320696414177 (355311 calls, 0.1% DB Load): SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastName", "User"."username" AS "User_username", "User"."email" AS "Us...
Query 8340688725808930900 (140053 calls, 0.1% DB Load): SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastName", "User"."username" AS "User_username", "User"."email" AS "Us...
Query 5264836271056515903 (80800 calls, 0.1% DB Load): INSERT INTO "usm-auth"."user_active_sessions"("id", "user_id", "access_token", "refresh_token", "created_at", "session_id", "updated_at") VALUES (DEFAULT, $1, $2, $3, DEFAULT, $4, DEFAULT) RETURNING "...
Query -1883058518535594495 (831741 calls, 0.1% DB Load): select max(age(datfrozenxid)) from pg_database...
Query 3250249039922133654 (3827072 calls, 0.1% DB Load): SELECT "RolePermissionCustomMapEntity"."id" AS "RolePermissionCustomMapEntity_id", "RolePermissionCustomMapEntity"."tenant_id" AS "RolePermissionCustomMapEntity_tenant_id", "RolePermissionCustomMapEnt...
Query 6405722557784641090 (4 calls, 0.1% DB Load): SELECT * FROM "usm-auth".user_session_history
ORDER BY id ASC...
Query 1071062769757489602 (411691 calls, 0.0% DB Load): SELECT DISTINCT "distinctAlias"."User_id" AS "ids_User_id" FROM (SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastN...
Query 2088996379308184075 (14533 calls, 0.0% DB Load): SELECT "MigratedUser"."_id" AS "MigratedUser__id", "MigratedUser"."email" AS "MigratedUser_email", "MigratedUser"."encrypted_password" AS "MigratedUser_encrypted_password", "MigratedUser"."sign_in_cou...
Query -8345834931380993534 (3254439 calls, 0.0% DB Load): SELECT value FROM rds_heartbeat2...
Query -2379261236625666809 (91688 calls, 0.0% DB Load): INSERT INTO "usm-auth"."user_session_history"("id", "user_id", "session_id", "start_time", "end_time", "created_at", "updated_at") VALUES (DEFAULT, $1, $2, DEFAULT, DEFAULT, DEFAULT, DEFAULT) RETURNIN...
Query -5373735545293231411 (12 calls, 0.0% DB Load): COPY "usm-auth".email_history (id, tenant_id, email, type, created_at, user_id) TO stdout...
Query -557368744523344395 (768 calls, 0.0% DB Load): SELECT DISTINCT "distinctAlias"."User_id" AS "ids_User_id" FROM (SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastN...
Query -2070594015537868089 (75004 calls, 0.0% DB Load): SELECT "SessionDataEntity"."id" AS "SessionDataEntity_id", "SessionDataEntity"."user_id" AS "SessionDataEntity_user_id", "SessionDataEntity"."clientId" AS "SessionDataEntity_clientId", "SessionDataEnt...
Query 1568279491779908477 (768 calls, 0.0% DB Load): SELECT "User"."id" AS "User_id", "User"."name" AS "User_name", "User"."firstName" AS "User_firstName", "User"."lastName" AS "User_lastName", "User"."username" AS "User_username", "User"."email" AS "Us...
Query 4157491171487736288 (61845 calls, 0.0% DB Load): INSERT INTO "usm-auth"."session_data"("id", "user_id", "clientId", "session_id", "access_token", "refresh_token", "created_at", "updated_at") VALUES (DEFAULT, $1, $2, $3, $4, $5, DEFAULT, DEFAULT) RET...
Query 2318934160592076983 (813619 calls, 0.0% DB Load): select coalesce(max(pg_current_wal_lsn()::pg_lsn - slots.restart_lsn), $1) as slot_byte_lag from (select restart_lsn from pg_replication_slots where restart_lsn is not null) slots...
Query -455188151573992261 (26522 calls, 0.0% DB Load): INSERT INTO "usm-auth"."user_session_history"("id", "user_id", "session_id", "start_time", "end_time", "created_at", "updated_at", "app_id") VALUES (DEFAULT, $1, $2, DEFAULT, DEFAULT, DEFAULT, DEFAULT...

2. BLOAT: [<Record schemaname='usm-auth' table='external_users' live_tuples=2120 dead_tuples=103 dead_ratio=4.63 last_autovacuum=datetime.datetime(2025, 5, 16, 8, 50, 1, 330152, tzinfo=datetime.timezone.utc) total_bytes=229376 total_size='224 kB'>, <Record schemaname='usm-auth' table='user_active_sessions' live_tuples=12073 dead_tuples=393 dead_ratio=3.15 last_autovacuum=datetime.datetime(2026, 2, 6, 6, 41, 41, 154936, tzinfo=datetime.timezone.utc) total_bytes=37462016 total_size='36 MB'>, <Record schemaname='usm-auth' table='user_ext' live_tuples=2427 dead_tuples=68 dead_ratio=2.73 last_autovacuum=datetime.datetime(2024, 10, 26, 3, 48, 23, 648738, tzinfo=datetime.timezone.utc) total_bytes=557056 total_size='544 kB'>, <Record schemaname='usm-auth' table='users' live_tuples=7003 dead_tuples=130 dead_ratio=1.82 last_autovacuum=datetime.datetime(2025, 8, 22, 1, 11, 13, 94997, tzinfo=datetime.timezone.utc) total_bytes=925696 total_size='904 kB'>]
3. CONFIG: [<Record setting='autovacuum_vacuum_scale_factor' current_value='0.1' unit=None>, <Record setting='effective_cache_size' current_value='47625' unit='8kB'>, <Record setting='maintenance_work_mem' current_value='65536' unit='kB'>, <Record setting='max_connections' current_value='81' unit=None>, <Record setting='shared_buffers' current_value='23812' unit='8kB'>, <Record setting='work_mem' current_value='4096' unit='kB'>]
4. UNUSED INDEXES: []

YOUR GOAL: 
Explain the score and prioritize the issues. 
If a query has high 'DB Load %' (even if low latency), it is a CRITICAL optimization target. 
Demand specific fixes (like "Add index for join") in your explanation.

OUTPUT JSON FORMAT:
{
  "health_score": 45,
  "issues": [
    {
      "type": "QUERY" | "CONFIG" | "SCHEMA",
      "severity": "CRITICAL" | "WARNING" | "INFO",
      "title": "Title",
      "description": "Explain WHY this matters based on stats.",
      "action_payload": "Context"
    }
  ]
}

STRICT RULES FOR 'type' AND 'action_payload':
1. type="QUERY": Use ONLY for specific slow/heavy queries from the WORKLOAD SUMMARY.
   - action_payload MUST be the 'queryid' (e.g., "123456789"). DO NOT put SQL here.
2. type="SCHEMA": Use for Bloat, Vacuum, or Missing Index issues.
   - action_payload MUST be the generic SQL command to fix it (e.g., "VACUUM FULL public.users;", "CREATE INDEX ON...").
3. type="CONFIG": Use for Postgres settings (work_mem, etc).
   - action_payload MUST be the SQL command to change it (e.g., "ALTER SYSTEM SET work_mem = '64MB';").
}
